# Sierra Developer Guide

## Overview

### Libraries used

- The application is based on [Next.js](https://nextjs.org/docs/getting-started) and [Material UI](https://material-ui.com/getting-started/usage/) on the frontend.
- [Prisma 2](https://www.prisma.io/docs/concepts/overview/what-is-prisma) is used to interact with a PostgreSQL database. Prisma handles all migrations and also provides an admin GUI.
- [Zod](https://github.com/colinhacks/zod) is used for data validation. It's a TypeScript analog to Joi.
- [React Final Form](https://final-form.org/docs/react-final-form/getting-started) is used for managing form state, especially in combination with [mui-rff](https://github.com/lookfirst/mui-rff) for the integration between Material UI and React Final Form.

### File structure

| Directory                  | Description                                                  |
| -------------------------- | ------------------------------------------------------------ |
| `components/COMPONENT/...` | Reusable components related to the named component.          |
| `components/common/...`    | Reusable components that aren't specifically related to Sierra. |
| `lib/COMPONENT/...`        | Utility code related to the named component.                 |
| `lib/...`                  | Utility code that isn't React components.                    |
| `pages/api/COMPONENT/...`  | API methods related to the named component.                  |
| `pages/COMPONENT/...`      | Full-page React components related to the named component.   |
| `public/...`               | Static assets.                                               |
| `prisma/schema.prisma`     | The source of truth for the database layout.                 |
| `prisma/seed.ts`           | A script that is run whenever the development database is reset. |
| `prisma/migrations/...`    | Migrations, typically generated by Prisma.                   |
| `styles/...`               | CSS files, prefer using Material `makeStyles` instead.       |

### Data model

The data model is described in `prisma/schema.prisma`, and is the source of truth for the database schema. Read this file for documentation.

## Runbook

### Set up development environment (first time)

Set up a Google app for SSO. From [the console](https://console.cloud.google.com/apis/credentials), create an "OAuth client ID". The only important setting is the "Authorized redirect URIs", which must be `http://localhost:3000/api/auth/callback/google`. Note the "Client ID" and "Client secret".

```bash
docker-compose -f docker-compose.local.yml up -d
cp .env.sample .env
# Edit this file
prisma migrate reset
yarn dev
```

### Set up development environment (normal)

```bash
docker-compose -f docker-compose.local.yml up -d
yarn dev
```

To access the Prisma database admin management console, use:

```bash
prisma studio
```

### Modify the database schema

Make your change to `prisma/schema.prisma`, then:

```bash
prisma migrate dev
```